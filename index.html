<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/tpp-white-list/icon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/tpp-white-list/icon/favicon.svg" />
    <link rel="shortcut icon" href="/tpp-white-list/icon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/tpp-white-list/icon/apple-touch-icon.png" />
    <link rel="manifest" href="/tpp-white-list/icon/site.webmanifest" />
    <title>TPP TCG Cards</title>
    <style>
        body {
            background-color: #222;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        h1 {
            color: white;
        }

        #mainContent {
            transition: margin-right 0.3s ease-in-out;
            display: grid;
            justify-content: center;
        }

        #searchContainer {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .searchBar {
            width: 40%;
            padding: 10px;
            font-size: 16px;
        }

        #cardContainer {
            gap: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, 150px);
            justify-content: center;
            position: relative;
        }

        .card {
            width: 150px;
            height: auto;
            cursor: pointer;
        }

        #cardinfo {
            display: none;
            background-color: rgba(51, 51, 51, 0.8);
            padding: 15px;
            width: 25%;
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            box-shadow: -5px 0 5px rgba(0, 0, 0, 0.5);
            text-align: left;
        }

        #cardinfo h2,
        .details h2 {
            font-size: 20px;
            color: white;
            text-align: center;
        }

        #cardinfo p,
        .details p {
            font-size: 14px;
            color: white;
            margin: 5px 0;
        }

        #bannerImage {
            width: calc(100% - 10px);
            max-width: 1300px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 16px;
        }

        .card .details {
            text-align: left;
            max-height: 0;
            transition: max-height 0.25s ease-in-out,
                padding 0.25s ease-in-out,
                margin-block 0.25s ease-in-out;
            overflow: scroll;
            position: absolute;

            left: 70px;
            width: calc(100vw - 160px);
            margin-block: 0;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 0;
        }

        .card .padder {
            height: 0;
            transition: height 0.25s ease-in-out;
        }

        .card.current .details {
            max-height: 200px;
            padding: 10px;
            margin-block: 10px;
        }

        .card.current .padder {
            height: 240px;
        }

        .card.current img {
            border: 5px solid #eac30b;
            margin: -5px;
        }
    </style>
</head>

<body>
    <div id="mainContent">
        <img id="bannerImage" src="Banner.png" />
        <h1>TPP TCG Cards</h1>
        <div id="searchContainer">
            <input type="text" id="nameSearch" class="searchBar" placeholder="Search by name..."
                onkeyup="filterCards()">
            <input type="text" id="effectSearch" class="searchBar" placeholder="Search by effect..."
                onkeyup="filterCards()">

            <!-- Sort dropdown -->
            <select id="sortOrder" onchange="sortCards()">
                <option value="asc">Sort: A-Z</option>
                <option value="desc">Sort: Z-A</option>
            </select>
        </div>
        <div id="cardContainer"></div>
    </div>

    <template id="singleCard">
        <div class="card">
            <img />
            <div class="details">
                <h2 class="infoName"></h2>
                <p><strong>Card Type:</strong> <span class="infoType"></span></p>
                <p class="infoAttributeWrapper"><strong>Attribute:</strong> <span class="infoAttribute"></span></p>
                <p class="infoLevelWrapper"><strong>Level:</strong> <span class="infoLevel"></span></p>
                <p><strong>Monster Type / Sub-Type:</strong> <span class="infoRace"></span></p>
                <p><strong>Effect:</strong> <span class="infoDesc"></span></p>
            </div>
            <div class="padder" ontransitionend="cardAnimationEnd()"></div>
        </div>
    </template>

    <script>
        let cardData = [];

        async function loadCardData() {
            try {
                const response = await fetch('card_data.json');
                cardData = await response.json();
                displayCards(cardData);
            } catch (error) {
                console.error("Error loading card data:", error);
            }
        }

        function normalizeSearchTerm(term) {
            return term.replace(/[?/'!,:&."]/g, "_").toLowerCase();
        }

        function displayCards(cards) {
            const container = document.getElementById("cardContainer");
            container.innerHTML = "";

            const template = document.querySelector("#singleCard");

            cards.forEach(card => {
                const formattedName = card.name.replace(/[?/'!,:&."]/g, "_").replace(/\s+/g, " ");
                const cardDom = template.content.cloneNode(true);
                let img = cardDom.querySelector("img");
                img.src = `card_images/${formattedName}.jpg`;
                img.classList.add("card");
                img.onclick = showCardInfo;

                cardDom.querySelector(".infoName").innerText = card.name;
                cardDom.querySelector(".infoType").innerText = card.type;
                cardDom.querySelector(".infoAttribute").innerText = card.attribute;
                cardDom.querySelector(".infoLevel").innerText = card.level;
                cardDom.querySelector(".infoRace").innerText = card.race;
                cardDom.querySelector(".infoDesc").innerText = card.desc;

                cardDom.querySelector(".infoAttributeWrapper").style.display = card.attribute ? "block" : "none";
                cardDom.querySelector(".infoLevelWrapper").style.display = card.level ? "block" : "none";

                container.appendChild(cardDom);
            });
        }

        function sortCards() {
            filterCards(); // Calls filterCards() so sorting applies dynamically
        }

        function filterCards() {
            const nameSearchText = normalizeSearchTerm(document.getElementById("nameSearch").value);
            const effectSearchText = document.getElementById("effectSearch").value.toLowerCase();

            const filteredCards = cardData.filter(card => {
                const normalizedCardName = normalizeSearchTerm(card.name);
                const nameMatch = nameSearchText.split("*").every(term => normalizedCardName.includes(term.trim()));
                const effectMatch = effectSearchText.split("*").every(term => card.desc.toLowerCase().includes(term.trim()));
                return nameMatch && effectMatch;
            });

            // Apply sorting after filtering
            const sortOrder = document.getElementById("sortOrder").value;
            filteredCards.sort((a, b) => sortOrder === "asc" ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name));

            displayCards(filteredCards);
        }

        let currentCard = null;
        let queuedChange = null;
        function showCardInfo(event) {
            let animated = {};
            if (currentCard) {
                currentCard.classList.remove("current");
                let animated = currentCard.querySelector(".padder");
            }

            if (event.currentTarget.parentElement === currentCard) {
                currentCard = null;
            } else {
                let next = event.currentTarget.parentElement;
                queuedChange = () => {
                    next.classList.add("current");
                    currentCard = next;
                };
                setTimeout(() => { cardAnimationEnd(); }, 250);
                if (!currentCard) {
                    cardAnimationEnd();
                }
            }
        }

        function cardAnimationEnd() {
            if (queuedChange) {
                queuedChange();
                queuedChange = null;
            }
        }

        window.onload = loadCardData;
    </script>
</body>

</html>
